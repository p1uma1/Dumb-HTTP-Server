package org.example.httpServer.utils;

import org.example.request.RequestHandler;

import java.io.*;
import java.net.Socket;
import java.nio.ByteBuffer;
import java.nio.CharBuffer;
import java.nio.charset.CharsetDecoder;
import java.nio.charset.CoderResult;
import java.nio.charset.CodingErrorAction;
import java.nio.charset.StandardCharsets;
import java.util.Map;

public class ByteStreamReader implements Closeable {
    private InputStream in;
    private byte[] buffer;
    private int bufferSize;
    private Socket clientSocket;


    public ByteStreamReader(InputStream in,int size,Socket clientSocket) {
        this.bufferSize=size;
        this.in = in;
        buffer = new byte[this.bufferSize];
        this.clientSocket=clientSocket;
    }
    public String read() throws IOException {
        StringBuilder sb = new StringBuilder();
        ByteArrayOutputStream headerBuf = new ByteArrayOutputStream();


        int b;
        int bodyIndex=-1;

        while((b=in.read())!=-1){

            headerBuf.write(b);
            String h = headerBuf.toString(StandardCharsets.UTF_8);
            if ((bodyIndex=h.indexOf("\r\n\r\n"))>0 ) {
                bodyIndex+=3;
                break;
            }
            if((bodyIndex=h.indexOf("\n\n"))>0){
                bodyIndex+=1;
                break;
            }
        }
        if(bodyIndex>0){
            byte[] headers= headerBuf.toByteArray();

            RequestHandler req = new RequestHandler(new String(headers),this.clientSocket);
            req.parseRequest();

            int contentLength= Integer.parseInt(req.getHeaders(req.getHeaders()).get("Content-Length"));
//            System.out.println("Req: \n"+new String(headers));
//            byte[] body = new byte[contentLength];

            for(int i=0;i<contentLength;i++){
                b=in.read();
                if(b==-1){
                    break;
                }
                headerBuf.write(b);
            }
            return new String(headerBuf.toByteArray());

        }
        return "Error";
    }



    public int read(String string) throws IOException {
        StringBuilder sb =new StringBuilder();
        Reader reader = new InputStreamReader(in, StandardCharsets.UTF_8);

        int ch;
        boolean startedWatching=false;
        char previousChar=Character.MIN_VALUE;
        char beforePreveiousChar = Character.MIN_VALUE;
        char beforeBeforePreveiousChar = Character.MIN_VALUE;
        boolean endOfBody = false;
        boolean endOfHeaders = false;
        int counter = 0;

        while ((ch = reader.read()) != -1 && !endOfBody) {
            char c = (char) ch;
            if(endOfHeaders){  //body
                counter++;
            }

            else if (c == '\r' || c == '\n') {  // \r or \n
                if (!startedWatching) startedWatching = true;
                else if (c == '\n' && previousChar == '\n') //\n \n
                {
                    endOfHeaders = true;
                } else if (c == '\n' && previousChar == '\r' && beforePreveiousChar == '\n' && beforeBeforePreveiousChar == '\r') {
                    endOfHeaders = true;
                }
                beforeBeforePreveiousChar=beforePreveiousChar;
                beforePreveiousChar=previousChar;
                previousChar=c;

            } else if(startedWatching){
                startedWatching = false;
            }

            sb.append(c);

        }
        string=sb.toString();
        return counter;
    }





    @Override
    public void close() throws IOException {

    }
}
